<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>nx_metadata_sdk: Using dynamic libraries in Plugins</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">nx_metadata_sdk
   &#160;<span id="projectnumber">1.0</span>
   </div>
   <div id="projectbrief">Metadata SDK</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Using dynamic libraries in Plugins </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>// Copyright 2018-present Network Optix, Inc. Licensed under MPL 2.0: www.mozilla.org/MPL/2.0/</p>
<p>This document describes issues which may arise when a Plugin dynamic library depends on any other dynamic libraries, either taken from the OS (Windows or Linux), or coming with the Plugin in its dedicated directory.</p>
<p>The consequences of not following the recommendations below can vary from Plugin loading failures to VMS Server crashes. And even if the Plugin works well with the particular VMS version on a particular OS version, the failures may appear when VMS or OS is upgraded.</p>
<p>The root cause of these issues is the fundamental deficiency of the OS mechanisms which resolve the symbols after loading a dynamic library.</p>
<p>Note that if a plugin is statically linked to certain libraries, it does not guarantee that symbols from that libraries are not present in the imported/exported symbol table in the plugin dynamic library. </p><hr/>
 <h2>Depending on libraries bundled with the VMS</h2>
<p>A properly written Plugin is expected to remain compatible with any future version of the VMS, including minor updates like monthly patches. So, if the Plugin is dynamically linked to any of the libraries which come with the VMS installation, it may malfunction with any VMS version which has any changes in those libraries. Such changes are expected to appear frequently. This issue may happen regardless of whether the library referenced by the Plugin is an integral part of the VMS code, or is a third-party library which the VMS depends on.</p>
<p>SOLUTION: The Plugin should never depend on any dynamic library bundled with the VMS installation. </p><hr/>
 <h2>Depending on system libraries</h2>
<p>Using any dynamic library from the OS by a Plugin is unsafe. The reason for that is the limitation of the dynamic library concept in Windows and Linux-like systems, described below.</p>
<p>When a library (in this case a Plugin) is being loaded, and this library imports (requires) some symbol (a function or a global variable) from another library, there is no direct control of which physical library will this particular symbol be taken from. The Plugin author can only specify which libraries the Plugin depends on, and (separately from that) which symbols the Plugin requires (without attributing them to libraries). When the Plugin is being loaded, each required symbol will first be looked up in the libraries already loaded into the process. If it happens to be found in a library which is bundled with the VMS, it will be taken from there, even if the plugin library specifies that it depends on another library (e.g. another version of the same library) which also contains such symbol.</p>
<p>EXAMPLE: The Plugin depends on <code>libxxx.so</code> located in the OS, and works great with the VMS version A. But in the VMS version B it has been decided to bundle the VMS with <code>libxxx.so</code>, possibly having some internal differences to the Plugin's <code>libxxx.so</code>. So, after the VMS upgrade from A to B, this Plugin will automatically start working with VMS'es <code>libxxx.so</code> instead of the OS'es one, and this cannot be changed. Note that this happens in both cases: <code>libxxx.so</code> is the Linux system library, or it comes bundled with the Plugin in its directory.</p>
<p>SOLUTION: The Plugin should be linked to system libraries statically, except for <code>libc</code> (but not <code>libstdc++</code>, see below) which is never bundled with the VMS, is designed to be backwards-compatible, and will not be patched for the need of a certain project. </p><hr/>
 <h2>Depending on libstdc++ on Linux</h2>
<p><code>libstdc++</code> - the GCC C++ standard library implementation - should be linked dynamically. There is a known issue in GCC's <code>libstdc++</code> - when linked statically, if some part of the product (in our case it will be the VMS Server) links to this library dynamically, the input/output streams like <code>std::cerr</code> will be initialized incorrectly, which may lead to output disruption and/or crashes.</p>
<p>This library must not be bundled with the plugin, because the one coming with the Server will be used anyway, due to the symbol resolution mechanism.</p>
<p>Note that the plugin must use the version of <code>libstdc++</code> compatible with the one of the Server with which the plugin is supposed to work. So, it is theoretically possible that at some point in the future the Server will be upgraded to the one using some newer incompatible <code>libstdc++</code>, and so the plugin will malfunction, including being unable to load or crashing.</p>
<p>SOLUTION: For the plugin, use Clang together with its native <code>libc++</code> instead of <code>libstdc++</code>, and link to <code>libc++</code> statically to make sure that the plugin will function properly even if the Server will start using <code>libc++</code> at some point in the future. </p><hr/>
 <h2>Depending on Visual C++ runtime on Windows</h2>
<p>When using Visual Studio to compile a plugin on Windows, and choosing to use dynamic linking with the Visual C++ Runtime Redistributable (msvcp140.dll), the resulting plugin may be not compatible with the VMS built using the toolsets (compilers) that use an older runtime version. The newer runtime version will do fine.</p>
<p>For example, as of 2024-07-19, the std::mutex ABI has undergone a breaking change in the toolset version 14.40 as opposed to 14.38, which did not happen for years before that. And now if a plugin uses std::mutex, is compiled with 14.40, and is used in VMS compiled with 14.38, it will crash. More details on this issue can be found here: <a href="https://developercommunity.visualstudio.com/t/Access-violation-with-std::mutex::lock-a/10664660">Visual Studio forum</a></p>
<p>Currently, the recommendation is either to use the toolset version not newer than 14.38, or to link the plugin with the C++ runtime statically. </p><hr/>
 <h2>Bundling public libraries with the Plugin</h2>
<p>NOTE: Here we discuss bundling the Plugin with publicly available dynamic libraries; bundling the Plugin with dynamic libraries written by the Plugin vendor is fine, provided that they use some unique symbol naming scheme, e.g. vendor-specific namespaces or prefixes.</p>
<p>There is no way for a single process to be dynamically linked with several libraries containing identical symbols, so that some parts of the process use these symbols from one library, and some other parts - from another library. So, if VMS is using a certain library A, regardless of whether it is a Linux system library or it is bundled with VMS, the plugin physically cannot use any other library (regardless of whether it has the same name A) which would provide the same symbols.</p>
<p>EXAMPLE: The Server uses <code>libssl.so.1.0.0.</code> The Plugin author decided to modify SSL library sources and make a dynamic library out of them, having the symbols (function names) in it unchanged, and bundles this library with the Plugin. It will not work as expected - when the Plugin is loaded, its code will be tuned by the Linux library loader to use functions from the <code>libssl.so.1.0.0</code> used by the Server (and already loaded into the process), and the modified library will not be loaded. This takes place regardless of whether the modified SSL library is called <code>libssl.so.1.0.0</code> or differently - only the symbols (funciton names) matter.</p>
<p>SOLUTION: The Plugin should be linked to public libraries statically. </p>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.14
</small></address>
</body>
</html>
